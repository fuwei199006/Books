 ### 请求与响应    

#### 客户端和服务器的通信    
1. 当用户在浏览器中输入一个网址时候，如果输入的是一个域名，则根据本机的网关和DNS服务器来解析出访问的真正的IP地址。如果是直接访问IP则直接与服务器通信，发送请求。    

2. 发送请求的时候会经历TCP三次握手过程（http也是基于TCP的协议），在第三次握手的时候，浏览器会根据http协议，把请求的内容封装成请求报文，发送给web服务器.      

3. 由于HTTP在每次请求结束后都会主动释放连接，因此HTTP连接是一种“短连接”.          

#### 服务器的监听(IIS6.0+版本)     
1. 当请求到达服务器时，经过各种处理，这个http请求最终会到达TCPIP.SYS驱动程序，TCPIP.SYS将这个请求转发给HTTP.SYS网络驱动程序的请求队列中（可以理解为专门处理http请求的进程），当然在处理请求的过程中，HTTP.SYS进程会维护一个配置表用缓存请求的url和和应用程序池对应的关系。   

2. 当一个http请求被捕获到，HTTP.SYS会读取配置表，如果对应的应用程序没有启动，则HTTP.SYS会启动相对应的应用程序。
3. ![图片]  
4. HTTP.SYS这个程序运行在系统内核级的应用程序，所以运行级别和效率都高于一般的用户级应用程序。如果web网站的某部分资源请求比较频繁的话，HTTP.SYS会对资源进行缓存，进而节约了内核级程序到用户级程序的调用，提高效率节省资源。


#### 服务器的处理    

##### W3SVC
1. W3SVC服务是一个独立运行的程序，寄宿在svchost.exe进程中，负责用户的参数监视和重新启动应用池的工作。 当一个请求进入HTTP.SYS的队列中，会通知W3SVC服务根据IIS中的配置去创建对应的应用进程，进行处理。   
2. IIS5中W3SVC是集成在IIS中（inetinfo.exe）.

##### W3Core或W3WP.exe   
1. 当HTTP.SYS把请求传递给IIS时候，会启动对应的应用程序池（w3wp.exe).     
   - 当用户请求的是静态文件，如：HTML和图片等，IIS会直接读取文件内容，转成二进制文件流，返回给HTTP.SYS。    
   
   - 当请求非静态文件，如：.aspx。      
        1. w3wp.exe会根据IIS中配置的映射(处理程序映射)读取对应的处理的Dll，用asp.net举例：当用户访问的网站是asp.net平台，则最终访问的是.cshtml和.aspx文件类型。根据配置w3wp.exe会加载aspnet_isapi.dll(简称是ISAPI).    
        2.  当ISAPI加载后，会启动一个ASP.NET的工作进程(ASPNET_WP.exe)，把信息的控制权交给ASPNET_WP.exe来处理。




